name: CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}

    - name: Install dependencies
      uses: borales/actions-yarn@v4
      with:
          cmd: --frozen-lockfile install

    - name: Build
      run: npm run build
      env: 
        CI: false
        
    - name: Run and test app
      run: |
        npm run start &       
        sleep 5 &
        curl http://localhost:3000 -I &
        sudo apt-get update
        sudo apt-get install -y libgbm1 &
        npm run test
        
    # deploy the react app to github pages
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        # NOTE: GITHUB_TOKEN is a secret token that is automatically generated by GitHub
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build # directory to deploy

    - name: Notify slack
      id: slack
      uses: slackapi/slack-github-action@v1.24.0
      # https://api.slack.com/apps/<your-app-id>/incoming-webhooks
      if: ${{ failure() }}
      with:
        channel-id: 'C078K0HGGE6' # slack channel #alerts-test
        payload: |
          {
            "text": "GitHub Action failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Production deployment check failed* :fire_engine:\n High error rate detected after deployment! Rolling back..."
                }
              },
              {
                "type": "actions",
                "elements": [
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": ":github: Failed action"
                    },
                    "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  },
                  {
                    "type": "button",
                    "text": {
                      "type": "plain_text",
                      "text": ":grafana: Grafana dashboard"
                    },
                    "url": "https://<your_organization>.grafana.net/d/my-app-dashboard?from=now-1h&to=now"
                  }
                ]
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_NOTIFICATIONS_TOKEN }}
        SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK



    
